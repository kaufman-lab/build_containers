# build_containers

This repo builds and stores singularity images to be used in lab workflows.

## Available Images

The set of image types that are available are displayed on the right under "packages".

Currently there is only one image type (package) called `geospatial_plus` which builds on the [rocker](https://github.com/rocker-org/rocker-versioned2) geospatial docker image. Our geospatial_plus image includes a few additional packages and also has configured the R user library location to avoid clashing with the user library on the host machine. Note that in order to use this package properly, you'll need to bind the directory `/pseudohome` to a directory on the host machine.

## Setting Github Credentials in Singularity

You'll need to provide a github token to singularity before you can download images/packages. This even applies to public images such as in this repository.

Generate a token [here](here), then run:

```
echo <token> | singularity remote login -u <github userame> --password-stdin  oras://ghcr.io
```

## Using Images

If you'd like to test out an image interactively, try

    singularity shell oras://ghcr.io/kaufman-lab/geospatial_plus:4.1.0

Note that singularity will cache remote images, so there's no need to explicitly save an images to disk using `singularity pull`, even if you're using it repeatedly.

If you want to guarantee code will always use the exact same image, you can use a digest instead of a tag. e.g.:

    oras://ghcr.io/kaufman-lab/geospatial_plus@sha256:199a842f806cde1c0df27a9be5cb1e594c9ed05bb3866db851bc0815e6630497

Note that in order to use these images with singularity you need to preface the package fingerprints with `oras://` (as in the examples).

Please disregard the instructions under packages on how to pull these images using docker commands. These are not docker images and those commands will not work. Those instructions are auto-generated by github and I don't know how to turn them off.

## Image Requests

Submit an issue if you'd like additional packages or software built into an image.

Depending on the complexity, we may start a new image type (package) or add to an existing package.

## Image Stability

starting sometime after 8/10/21 \`geospatial_plus:4.1.0\` will be package-stable (this is the date the next version of R is released and rocker will freeze 4.1.0). Even as rocker/geospatial:4.1.0 and kaufman-lab/geospatial_plus:4.1.0 are periodically rebuilt, R packages in the 4.1.0 image will remain constant [because of how versioned rocker images install packages](https://github.com/rocker-org/rocker-versioned2/issues/201).

I'll try not to make breaking changes within a version tag, but if stability is paramount use a digest (which points to an exact image uploaded on a specific date) rather than a tag.

## Building Images

This repository uses github actions to build images. Inspiration for this repo, along with more complicated examples for building multiple images can be found here: <https://github.com/singularityhub/github-ci>
